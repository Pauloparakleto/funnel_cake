<div class="section span-12">
	<h1><span>Funnel Stages</span></h1>
	<div class="section span-12">
		<%= render :partial => 'analytics/common/filter_fields_input', :style=>'font-size: 14px' %>
		<%= render :partial => 'analytics/common/daterange_label' %>
	</div>
	<div class="section span-12">
		<p>Click on a conversion stat for more details...</p>
		<div class="column span-4">
			<%- Analytics::Visitor.primary_states.each_with_index do |state, i| -%>
			 	<%= render 'stage', :state=>state, :date_range=>current_period(2.weeks),
														:top_label=>(i==0) if next_state_from(state) %>
			<%- end -%>
		</div>
		<img class='spinner' id='state_info_container_spinner' src='/images/ajax-loader.gif' style='display: none;'/>
		<div class='column span-8 last' id='state_info_container'>
		</div>
	</div>
</div>
<script type="text/javascript">
<%= render 'analytics/common/graph_update.js' %>
<%= render 'analytics/common/filter_fields_update.js' %>

	var updateAnalyticsStats = function() {
		<%= render :partial => 'analytics/common/grab_filter_fields.js' %>

		funnelChart.refreshData(periodStart(period), periodEnd(period), opts);
		setPeriodLabel(period);
		if (currentState) {
			funnelChartClickHandler($('funnel_stage_'+currentState).down('.funnel_rate_label'));
		}
	};

	var currentState = null;

	var funnelChartClickHandler = function(label) {
		currentState = label.up('.funnel_stage_container').id.replace(/funnel_stage_/,'');
		var state = currentState.split(/-/)[0];
		var next_state = currentState.split(/-/)[1];

		var p_start = periodStart($('date_period').value);
		var p_end = periodEnd($('date_period').value);

		<%= render :partial => 'analytics/common/grab_filter_fields.js' %>

		var params = $H({
			authenticity_token: '<%=escape_javascript(form_authenticity_token)%>',
			date_range_start: p_start,
			date_range_end: p_end
		}).merge(opts);

		$('state_info_container_spinner').show();
		$('state_info_container').hide();

		var label_state = label.id.sub(/funnel_rate_/,'');
		new Ajax.Request('stages/'+state+'-'+next_state,
			{
				asynchronous:true,
				evalScripts:true,
				method:'get',
				parameters: params,
				onComplete: function() {
					updateStateGraphs(periodDays($('date_period').value));
				}
			}
		);
	}

	var funnelChart = new FunnelChart('.funnel_stage', {
		padding: 10,
		authenticity_token: '<%=escape_javascript(form_authenticity_token)%>',
		clickHandler: function(event) {
			funnelChartClickHandler(Event.element(event));
		}
	});
	funnelChart.draw();
</script>
