<% diagram_container = 'diagram_container' if local_assigns[:diagram_container].nil? %>
<% diagram_scale = 0.6 if local_assigns[:diagram_scale].nil? %>
<script type="text/javascript">
var canviz;
var funnelChart;

var updatePage = function(period, redraw) {
	if (!redraw) { redraw = 0;	}
	$('spinner').appear({ duration: 0.5 });
	new Ajax.Request('/funnel_events/xdot_callback',
		{
			asynchronous:true,
			evalScripts:true,
			parameters: {
				authenticity_token: '<%=escape_javascript(form_authenticity_token)%>',
				start_days_ago: period,
				drawchart: redraw
			},
			onComplete:function(){
				$('funnel_container').setStyle({height: $('diagram_container').style.height});
				$('funnel_container_chart').setStyle({height: $('funnel_container_chart').style.height});
			}
		}
	);

	<% FunnelVisitor.primary_states.each_with_index do |state, i| %>
	<% if next_state_from(state) %>
	$('flotr_<%=state%>_spinner').appear({duration: 0.5});
	new Ajax.Request('/funnel_events/stats_graph',
		{
			asynchronous:true,
			evalScripts:true,
			method:'get',
			parameters: {
				authenticity_token: '<%=escape_javascript(form_authenticity_token)%>',
				state: '<%=state%>',
				days: period
			}
		}
	);
	<% end %>
	<% end %>

	$('daterange_label').update('Date Range: '+period+' days ago to today');
};

document.observe('dom:loaded', function() {
	canviz = new Canviz('<%=diagram_container%>');
	canviz.setImagePath('/images/');
	canviz.setScale(<%=diagram_scale%>);
	canviz.parse('<%= escape_javascript(render('diagram.xdot.erb')) %>');

	funnelChart = new FunnelChart( $('funnel_container'), [], {} );
	<%= funnel_event_nodes_javascript(30.days.ago..0.days.ago) %>
	funnelChart.funnel_nodes = nodes;
	funnelChart.redraw();

	<% FunnelVisitor.primary_states.each_with_index do |state, i| %>
	<%= funnel_event_flotr_init(state) if next_state_from(state) %>
	<% end %>

	updatePage($('date_chooser').value);
});
</script>
